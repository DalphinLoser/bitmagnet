
services:
  bitmagnet:
    container_name: bitmagnet
    image: ghcr.io/bitmagnet-io/bitmagnet:latest
    volumes:
      # Mount data folder (currently only used for logs when file rotation is enabled):
      - ./data/bitmagnet:/root/.local/share/bitmagnet
    restart: unless-stopped
    environment:
      # Enable logging to rotating files for ingest to Loki:
      LOG_FILE_ROTATOR_ENABLED: ${LOG_ROTATOR_ENABLED:-true}
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      TMDB_API_KEY: ${TMDB_API_KEY}
    network_mode: service:gluetun
    depends_on:
      postgres:
        condition: service_healthy
    command:
      - worker
      - run
      # Run all workers:
      - --all
      # Or enable individual workers:
      # - --keys=http_server
      # - --keys=queue_server
      # - --keys=dht_crawler

  gluetun:
    container_name: bitmagnet-gluetun
    image: qmcgaw/gluetun:latest
    cap_add:
      - NET_ADMIN
    ports:
      # The bitmagnet ports must be exposed by the gluetun container:
      - "${BITMAGNET_PORT:-3333}:3333"
      # BitTorrent ports:
      - "${BT_PORT:-3334}:3334/tcp"
      - "${BT_PORT_UDP:-3334}:3334/udp"
    environment:
      # Put your personal gluetun/VPN account config and credentials here:
      # (See https://github.com/qdm12/gluetun-wiki/tree/main/setup/providers)
      VPN_SERVICE_PROVIDER: ${VPN_PROVIDER:-provider}
      OPENVPN_USER: ${OVPN_USER:-user}
      OPENVPN_PASSWORD: ${OVPN_PASSWORD:-password}
    restart: always
    # Host names must be manually mapped here for bitmagnet to resolve them:
    extra_hosts:
      - "postgres:${POSTGRES_IP:-192.168.55.11}"
    networks:
      bitmagnet:
        ipv4_address: ${GLUETUN_IP:-192.168.55.10}

  postgres:
    image: postgres:16-alpine
    container_name: bitmagnet-postgres
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      bitmagnet:
        ipv4_address: ${POSTGRES_IP:-192.168.55.11}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    shm_size: 1g
    restart: unless-stopped
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-bitmagnet}
      - PGUSER=${PGUSER:-postgres}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready"]
      interval: 10s
      start_period: 20s

networks:
  bitmagnet:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 192.168.55.0/24
          gateway: 192.168.55.1
